<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Êó•Êú¨ÊóÖÈÅäÂä©Êâã</title>
    
    <!-- PWA Ë®≠ÂÆö -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#254636">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <!-- ÂºïÂÖ• Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- ÂºïÂÖ• FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* ÈÖçËâ≤‰∏ªÈ°å */
            --bg-color: #254636;
            --highlight: #F2EBD9;
            --accent-red: #CC5A5A; 
            --text-main: #FFFFFF;       
            --text-sub: #D8DCD6;
            --danger: #FF8B8B;
            --success: #6EE7B7;
            
            /* ÁéªÁíÉÊì¨ÊÖã */
            --glass-bg: rgba(255, 255, 255, 0.12); 
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.25);
            --glass-blur: blur(12px);
            --input-bg: rgba(0, 0, 0, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: linear-gradient(160deg, #254636 0%, #1A3326 100%);
            color: var(--text-main);
            height: 100vh;
            display: flex; justify-content: center;
        }

        #app {
            width: 100%; max-width: 480px; height: 100%;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }

        /* Header */
        header { padding: 20px; text-align: center; flex-shrink: 0; padding-top: env(safe-area-inset-top, 20px); }
        .clock-widget h1 { font-size: 3.8rem; margin: 0; font-weight: 700; letter-spacing: 2px; text-shadow: 0 4px 12px rgba(0,0,0,0.3); color: var(--highlight); }
        .clock-widget .location { font-size: 0.9rem; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 15px; color: var(--text-sub); }
        .weather-pill {
            display: inline-flex; align-items: center; background: rgba(255,255,255,0.15); padding: 8px 20px;
            border-radius: 30px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .weather-pill i { margin-right: 8px; font-size: 1.1rem; color: var(--highlight); }
        .weather-pill span { font-size: 1.1rem; font-weight: 500; }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 20px 20px 80px 20px; }
        
        /* Glass Cards */
        .card {
            background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 20px; padding: 20px;
            margin-bottom: 20px; transition: transform 0.2s, border 0.3s;
        }
        .card.editing { border: 2px solid var(--accent-red); background: rgba(255, 255, 255, 0.2); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 1.1rem; font-weight: bold; color: var(--highlight); text-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        /* Tabs */
        .date-tabs { display: flex; justify-content: space-between; background: rgba(0,0,0,0.25); border-radius: 15px; padding: 5px; margin-bottom: 15px; }
        .date-tab { flex: 1; text-align: center; padding: 10px 5px; border-radius: 12px; font-size: 0.85rem; color: var(--text-sub); cursor: pointer; transition: all 0.3s; }
        .date-tab.active { background-color: var(--highlight); color: #254636; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Lists */
        .timeline-item { display: flex; margin-bottom: 20px; position: relative; }
        .timeline-time { width: 70px; font-size: 0.9rem; font-weight: 600; color: var(--highlight); padding-top: 5px; display: flex; flex-direction: column; align-items: flex-start; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .time-end { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; font-weight: 400; }
        .timeline-content { flex: 1; background: rgba(0, 0, 0, 0.2); padding: 12px 15px; border-radius: 12px; border-left: 3px solid var(--accent-red); }
        .timeline-title { font-size: 1rem; margin-bottom: 5px; }
        .timeline-loc { font-size: 0.8rem; color: var(--text-sub); display: flex; align-items: center; gap: 5px; }
        .action-btns { float: right; display: flex; gap: 12px; }
        .btn-icon { color: var(--text-sub); cursor: pointer; font-size: 0.85rem; transition: color 0.2s; }
        .btn-icon:hover { color: #fff; }
        .btn-icon.del:hover { color: var(--danger); }
        .btn-icon.edit:hover { color: var(--highlight); }

        /* Inputs */
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-group.nowrap { flex-wrap: nowrap; }
        input, select { background: var(--input-bg); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 10px; outline: none; flex: 1; min-width: 0; font-size: 0.95rem; }
        input:focus, select:focus { border-color: var(--accent-red); background: rgba(0,0,0,0.3); }
        ::placeholder { color: rgba(255,255,255,0.4); }
        option { background-color: #254636; color: #fff; } 
        .btn-block { display: flex; gap: 10px; }
        .btn-add { background: var(--accent-red); color: #fff; border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; flex: 1; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-cancel { background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* Packing */
        .progress-container { background: rgba(0,0,0,0.3); border-radius: 10px; height: 10px; width: 100%; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { background: var(--accent-red); height: 100%; transition: width 0.3s ease; box-shadow: 0 0 10px rgba(204, 90, 90, 0.4); }
        .pack-item { display: flex; align-items: center; background: rgba(0,0,0,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
        .pack-item:active { background: rgba(0,0,0,0.25); }
        .pack-checkbox { width: 22px; height: 22px; border: 2px solid var(--accent-red); border-radius: 6px; margin-right: 15px; display: flex; align-items: center; justify-content: center; color: transparent; }
        .pack-item.checked .pack-checkbox { background: var(--accent-red); color: #fff; }
        .pack-item.checked span { text-decoration: line-through; color: var(--text-sub); opacity: 0.7; }

        /* Currency */
        .rate-display { text-align: center; font-size: 2.5rem; font-weight: bold; color: var(--highlight); margin: 20px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .rate-sub { text-align: center; font-size: 0.8rem; color: var(--text-sub); margin-top: -15px; margin-bottom: 20px; }
        .converter-box { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.15); padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .currency-label { font-size: 1.2rem; font-weight: bold; min-width: 30px; text-align: center; color: var(--highlight);}
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); align-items: center; }
        .history-price { text-align: right; }
        .history-rate { font-size: 0.7rem; color: var(--highlight); }
        .payment-icon { margin-left: 5px; color: var(--accent-red); font-size: 0.9rem; }

        /* Nav */
        nav { position: absolute; bottom: 0; width: 100%; background: rgba(26, 51, 38, 0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 15px 0 25px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); z-index: 10; border-top: 1px solid rgba(255,255,255,0.1); padding-bottom: env(safe-area-inset-bottom, 25px); }
        .nav-item { color: rgba(255,255,255,0.5); text-align: center; cursor: pointer; flex: 1; transition: transform 0.1s; }
        .nav-item:active { transform: scale(0.95); }
        .nav-item i { font-size: 1.4rem; margin-bottom: 5px; display: block; }
        .nav-item span { font-size: 0.75rem; }
        .nav-item.active { color: var(--highlight); text-shadow: 0 0 10px rgba(242, 235, 217, 0.4); }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

<div id="app">
    <!-- Header -->
    <header v-if="currentTab === 'itinerary'">
        <div class="clock-widget">
            <h1>{{ japanTime }}</h1>
            <div class="location">Osaka, Japan</div>
            <div class="weather-pill" v-if="weather">
                <i :class="weatherIcon"></i>
                <span>{{ weather.temp }}¬∞ {{ weather.desc }}</span>
            </div>
            <div class="weather-pill" v-else>
                <span>ËºâÂÖ•‰∏≠...</span>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main>
        <!-- 1. Ë°åÁ®ã -->
        <section v-if="currentTab === 'itinerary'">
            <div class="card">
                <div class="date-tabs">
                    <div v-for="date in dates" :key="date.val" class="date-tab" :class="{ active: selectedDate === date.val }" @click="switchDate(date.val)">
                        <div>{{ date.weekday }}</div>
                        <div style="font-size: 1.1rem; margin-top: 2px;">{{ date.day }}</div>
                    </div>
                </div>
                <div v-if="filteredItinerary.length === 0" style="text-align: center; color: var(--text-sub); padding: 20px;">Â∞öÁÑ°Ë°åÁ®ã</div>
                <div v-for="(item, index) in filteredItinerary" :key="item.id" class="timeline-item">
                    <div class="timeline-time">
                        {{ item.time }}
                        <div v-if="item.endTime" class="time-end">~{{ item.endTime }}</div>
                    </div>
                    <div class="timeline-content">
                        <div class="action-btns">
                            <i class="fa-solid fa-pen btn-icon edit" @click="startEditItinerary(item)" title="Á∑®ËºØ"></i>
                            <i class="fa-solid fa-trash btn-icon del" @click="removeItinerary(item.id)" title="Âà™Èô§"></i>
                        </div>
                        <div class="timeline-title">{{ item.title || 'Êú™ÂëΩÂêçË°åÁ®ã' }}</div>
                        <div class="timeline-loc" v-if="item.location"><i class="fa-solid fa-location-dot"></i> {{ item.location }}</div>
                    </div>
                </div>
            </div>

            <div class="card" :class="{ editing: editingItineraryId !== null }">
                <div class="card-title">
                    <i v-if="editingItineraryId" class="fa-solid fa-pen-to-square"></i>
                    <i v-else class="fa-solid fa-plus"></i> {{ editingItineraryId ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }} ({{ selectedDate }})
                </div>
                <div style="margin-top: 15px;">
                    <div class="input-group">
                        <input type="time" v-model="newItem.time" required style="flex: 1;">
                        <select v-model="newItem.duration" style="flex: 1;">
                            <option value="0">ÁÑ°ÂçÄÈñì</option>
                            <option v-for="dur in durationOptions" :key="dur.val" :value="dur.val">{{ dur.label }}</option>
                        </select>
                    </div>
                    <div class="input-group"><input type="text" v-model="newItem.title" placeholder="Ë¶ÅÂÅö‰ªÄÈ∫º?"></div>
                    <div class="input-group"><input type="text" v-model="newItem.location" placeholder="Âú∞Èªû"></div>
                    <div class="btn-block">
                        <button v-if="editingItineraryId" class="btn-cancel" @click="cancelEditItinerary">ÂèñÊ∂à</button>
                        <button class="btn-add" @click="saveItinerary">{{ editingItineraryId ? 'ÂÑ≤Â≠ò‰øÆÊîπ' : 'Âä†ÂÖ•Ë°åÁ®ã' }}</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Ë°åÊùé -->
        <section v-if="currentTab === 'packing'">
            <div class="card">
                <div class="card-header"><div class="card-title">Ë°åÊùéÊ∫ñÂÇôÈÄ≤Â∫¶</div><div style="color: var(--highlight);">{{ packProgress }}%</div></div>
                <div class="progress-container"><div class="progress-bar" :style="{ width: packProgress + '%' }"></div></div>
                <div class="input-group">
                    <select v-model="newPack.category" style="flex: 1;">
                        <option disabled value="">ÈÅ∏ÊìáÂàÜÈ°û</option>
                        <option value="Ë≠â‰ª∂ËàáÈå¢ÂåÖ">Ë≠â‰ª∂ËàáÈå¢ÂåÖ</option>
                        <option value="Ë°£Áâ©">Ë°£Áâ©</option>
                        <option value="ÈõªÂô®">ÈõªÂô®</option>
                        <option value="Ëó•ÂìÅ">Ëó•ÂìÅ</option>
                        <option value="Áõ•Ê¥óÁî®ÂìÅ">Áõ•Ê¥óÁî®ÂìÅ</option>
                        <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                    </select>
                    <input type="text" v-model="newPack.name" placeholder="Áâ©ÂìÅÂêçÁ®±" style="flex: 2;">
                </div>
                <button class="btn-add" @click="addPackItem">Âä†ÂÖ•Ê∏ÖÂñÆ</button>
            </div>
            <div class="card" v-for="(items, category) in groupedPacking" :key="category">
                <div class="card-title" style="margin-bottom: 10px; font-size: 0.9rem;">{{ category }}</div>
                <div v-for="item in items" :key="item.id" class="pack-item" :class="{ checked: item.checked }" @click="togglePack(item)">
                    <div class="pack-checkbox"><i class="fa-solid fa-check"></i></div>
                    <span style="flex: 1;">{{ item.name }}</span>
                    <i class="fa-solid fa-xmark" style="color: var(--text-sub); padding: 5px;" @click.stop="removePack(item.id)"></i>
                </div>
            </div>
        </section>

        <!-- 3. ÂåØÁéá -->
        <section v-if="currentTab === 'currency'">
            <div class="card" style="text-align: center;">
                <div style="color: var(--text-sub); font-size: 0.9rem;">ÁõÆÂâçÂåØÁéá (JPY to TWD)</div>
                <div class="rate-display">{{ currentRate.toFixed(4) }}</div>
                <div class="rate-sub">ÊØè30ÂàÜÈêòÊõ¥Êñ∞ | ‰∏äÊ¨°Êõ¥Êñ∞: {{ lastRateUpdate }}</div>
                <div class="converter-box">
                    <span class="currency-label">¬•</span>
                    <input type="number" v-model="calcJpy" placeholder="Ëº∏ÂÖ•Êó•Âπ£" @input="calculateTwd" style="font-size: 1.2rem;">
                </div>
                <div style="font-size: 1.5rem; margin-bottom: 20px;">‚âà NT$ <span style="color: var(--highlight);">{{ calcTwd }}</span></div>
            </div>

            <div class="card" :class="{ editing: editingExpenseId !== null }">
                <div class="card-title">{{ editingExpenseId ? 'Á∑®ËºØÊ∂àË≤ª' : 'Ê∂àË≤ªË®òÈåÑ' }}</div>
                <div style="margin-top: 15px;">
                    <div class="input-group nowrap">
                        <select v-model="expense.method" style="flex: 0 0 75px; padding: 12px 5px; text-align: center;">
                            <option value="cash">üíµ</option>
                            <option value="card">üí≥</option>
                        </select>
                        <input type="text" v-model="expense.name" placeholder="Áâ©ÂìÅ" style="flex: 2;">
                        <input type="number" v-model="expense.price" placeholder="¬•" style="flex: 1.2;">
                    </div>
                    <div class="btn-block">
                        <button v-if="editingExpenseId" class="btn-cancel" @click="cancelEditExpense">ÂèñÊ∂à</button>
                        <button class="btn-add" @click="saveExpense">{{ editingExpenseId ? 'ÂÑ≤Â≠ò‰øÆÊîπ' : 'Ë®òÈåÑÊ∂àË≤ª' }}</button>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div v-for="(log, idx) in expenseLogs" :key="log.id" class="history-item">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; display: flex; align-items: center;">{{ log.name }}<span class="payment-icon"><i v-if="log.method === 'card'" class="fa-regular fa-credit-card"></i><i v-else class="fa-solid fa-money-bill-wave"></i></span></div>
                            <div style="font-size: 0.8rem; color: var(--text-sub);">{{ log.date }}</div>
                        </div>
                        <div class="history-price">
                            <div>¬•{{ log.price }}</div>
                            <div style="color: var(--success);">NT$ {{ Math.round(log.price * log.rate) }}</div>
                            <div class="history-rate">ÂåØÁéá: {{ log.rate.toFixed(4) }}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: center; gap: 8px; margin-left: 12px;">
                            <i class="fa-solid fa-pen btn-icon edit" @click="startEditExpense(log)"></i>
                            <i class="fa-solid fa-trash btn-icon del" @click="removeExpense(log.id)"></i>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Nav -->
    <nav>
        <div class="nav-item" :class="{ active: currentTab === 'itinerary' }" @click="currentTab = 'itinerary'"><i class="fa-solid fa-calendar-days"></i><span>Ë°åÁ®ã</span></div>
        <div class="nav-item" :class="{ active: currentTab === 'packing' }" @click="currentTab = 'packing'"><i class="fa-solid fa-suitcase"></i><span>Ë°åÊùé</span></div>
        <div class="nav-item" :class="{ active: currentTab === 'currency' }" @click="currentTab = 'currency'"><i class="fa-solid fa-sack-dollar"></i><span>ÂåØÁéá</span></div>
    </nav>
</div>

<!-- Service Worker Registration -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered!', reg))
                .catch(err => console.log('SW failed', err));
        });
    }
</script>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const japanTime = ref('00:00');
            const weather = ref(null);
            
            const updateTime = () => {
                const now = new Date();
                const jpnTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));
                const h = String(jpnTime.getHours()).padStart(2, '0');
                const m = String(jpnTime.getMinutes()).padStart(2, '0');
                japanTime.value = `${h}:${m}`;
            };

            const weatherCodeMap = {
                0: { desc: 'Êô¥Êúó', icon: 'fa-sun' }, 1: { desc: 'Â§öÈõ≤', icon: 'fa-cloud-sun' }, 2: { desc: 'Èô∞Â§©', icon: 'fa-cloud' },
                3: { desc: 'Èô∞Â§©', icon: 'fa-cloud' }, 45: { desc: 'Èúß', icon: 'fa-smog' }, 51: { desc: 'ÊØõÊØõÈõ®', icon: 'fa-cloud-rain' },
                61: { desc: '‰∏ãÈõ®', icon: 'fa-umbrella' }, 71: { desc: '‰∏ãÈõ™', icon: 'fa-snowflake' }, 95: { desc: 'Èõ∑Èõ®', icon: 'fa-bolt' }
            };
            const weatherIcon = computed(() => {
                if(!weather.value) return 'fa-solid fa-question';
                return 'fa-solid ' + (weatherCodeMap[weather.value.code]?.icon || 'fa-cloud');
            });
            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=34.6937&longitude=135.5023&current_weather=true&timezone=Asia%2FTokyo');
                    const data = await res.json();
                    if(data.current_weather) {
                        const code = data.current_weather.weathercode;
                        let displayCode = code;
                        if(code > 3 && code < 45) displayCode = 3;
                        if(code >= 51 && code <= 67) displayCode = 61;
                        if(code >= 71 && code <= 86) displayCode = 71;
                        weather.value = { temp: Math.round(data.current_weather.temperature), code: displayCode, desc: weatherCodeMap[displayCode]?.desc || 'Â§öÈõ≤' };
                    }
                } catch (e) { console.error("Weather error"); }
            };

            const dates = [{ val: '12/18', day: '12/18', weekday: 'ÈÄ±Âõõ' }, { val: '12/19', day: '12/19', weekday: 'ÈÄ±‰∫î' }, { val: '12/20', day: '12/20', weekday: 'ÈÄ±ÂÖ≠' }, { val: '12/21', day: '12/21', weekday: 'ÈÄ±Êó•' }];
            const selectedDate = ref('12/18');
            const itineraryList = ref(JSON.parse(localStorage.getItem('trip_itinerary')) || []);
            const newItem = ref({ time: '', title: '', location: '', duration: 0 });
            const editingItineraryId = ref(null);
            const durationOptions = computed(() => {
                let opts = [];
                for(let i = 1; i <= 12; i++) {
                    let val = i * 0.5;
                    let label = val % 1 === 0 ? `${val} Â∞èÊôÇ` : `${Math.floor(val)}Â∞èÊôÇ30ÂàÜ`;
                    if(val < 1) label = '30 ÂàÜÈêò';
                    opts.push({ val: val, label: label });
                }
                return opts;
            });
            const calcEndTime = (startTime, duration) => {
                if(!duration || duration == 0) return null;
                const [h, m] = startTime.split(':').map(Number);
                const totalMin = h * 60 + m + (duration * 60);
                const endH = Math.floor(totalMin / 60) % 24;
                const endM = Math.floor(totalMin % 60);
                return `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
            };
            const filteredItinerary = computed(() => itineraryList.value.filter(i => i.date === selectedDate.value).sort((a, b) => a.time.localeCompare(b.time)));
            const switchDate = (dateVal) => { selectedDate.value = dateVal; cancelEditItinerary(); };
            const saveItinerary = () => {
                if (!newItem.value.time) return alert('Ë´ãËá≥Â∞ëËº∏ÂÖ•ÊôÇÈñì');
                const endTimeStr = calcEndTime(newItem.value.time, newItem.value.duration);
                if (editingItineraryId.value) {
                    const index = itineraryList.value.findIndex(i => i.id === editingItineraryId.value);
                    if (index !== -1) {
                        itineraryList.value[index].time = newItem.value.time;
                        itineraryList.value[index].title = newItem.value.title;
                        itineraryList.value[index].location = newItem.value.location;
                        itineraryList.value[index].duration = newItem.value.duration;
                        itineraryList.value[index].endTime = endTimeStr;
                    }
                    editingItineraryId.value = null;
                } else {
                    itineraryList.value.push({ id: Date.now(), date: selectedDate.value, time: newItem.value.time, title: newItem.value.title, location: newItem.value.location, duration: newItem.value.duration, endTime: endTimeStr });
                }
                newItem.value = { time: '', title: '', location: '', duration: 0 }; saveData();
            };
            const startEditItinerary = (item) => { newItem.value = { time: item.time, title: item.title, location: item.location, duration: item.duration || 0 }; editingItineraryId.value = item.id; };
            const cancelEditItinerary = () => { newItem.value = { time: '', title: '', location: '', duration: 0 }; editingItineraryId.value = null; };
            const removeItinerary = (id) => { if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë°åÁ®ã?')) { itineraryList.value = itineraryList.value.filter(i => i.id !== id); if (editingItineraryId.value === id) cancelEditItinerary(); saveData(); } };

            const packingList = ref(JSON.parse(localStorage.getItem('trip_packing')) || []);
            const newPack = ref({ category: '', name: '' });
            const groupedPacking = computed(() => { const groups = {}; packingList.value.forEach(item => { if (!groups[item.category]) groups[item.category] = []; groups[item.category].push(item); }); return groups; });
            const packProgress = computed(() => { if (packingList.value.length === 0) return 0; const checked = packingList.value.filter(i => i.checked).length; return Math.round((checked / packingList.value.length) * 100); });
            const addPackItem = () => { if (!newPack.value.name) return; const category = newPack.value.category || 'ÂÖ∂‰ªñ'; packingList.value.push({ id: Date.now(), category: category, name: newPack.value.name, checked: false }); newPack.value.name = ''; saveData(); };
            const togglePack = (item) => { item.checked = !item.checked; saveData(); };
            const removePack = (id) => { packingList.value = packingList.value.filter(i => i.id !== id); saveData(); };

            const currentRate = ref(0.2150);
            const lastRateUpdate = ref('--:--');
            const calcJpy = ref('');
            const calcTwd = ref(0);
            const expenseLogs = ref(JSON.parse(localStorage.getItem('trip_expenses')) || []);
            const expense = ref({ name: '', price: '', method: 'cash' });
            const editingExpenseId = ref(null);
            const fetchRate = async () => { try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); const data = await res.json(); if(data.rates && data.rates.TWD) { currentRate.value = data.rates.TWD; const now = new Date(); lastRateUpdate.value = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`; } } catch (e) { console.log("Rate fetch failed"); } };
            const calculateTwd = () => { if(!calcJpy.value) calcTwd.value = 0; else calcTwd.value = Math.round(calcJpy.value * currentRate.value); };
            const saveExpense = () => {
                if(!expense.value.name || !expense.value.price) return;
                if (editingExpenseId.value) {
                    const index = expenseLogs.value.findIndex(l => l.id === editingExpenseId.value);
                    if (index !== -1) { expenseLogs.value[index].name = expense.value.name; expenseLogs.value[index].price = Number(expense.value.price); expenseLogs.value[index].method = expense.value.method; }
                    editingExpenseId.value = null;
                } else { expenseLogs.value.unshift({ id: Date.now(), name: expense.value.name, price: Number(expense.value.price), method: expense.value.method || 'cash', rate: currentRate.value, date: new Date().toLocaleDateString() }); }
                expense.value = { name: '', price: '', method: 'cash' }; saveData();
            };
            const startEditExpense = (log) => { expense.value = { name: log.name, price: log.price, method: log.method || 'cash' }; editingExpenseId.value = log.id; };
            const cancelEditExpense = () => { expense.value = { name: '', price: '', method: 'cash' }; editingExpenseId.value = null; };
            const removeExpense = (id) => { if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ê∂àË≤ªÁ¥ÄÈåÑ?')) { expenseLogs.value = expenseLogs.value.filter(l => l.id !== id); if (editingExpenseId.value === id) cancelEditExpense(); saveData(); } };
            const saveData = () => { localStorage.setItem('trip_itinerary', JSON.stringify(itineraryList.value)); localStorage.setItem('trip_packing', JSON.stringify(packingList.value)); localStorage.setItem('trip_expenses', JSON.stringify(expenseLogs.value)); };

            onMounted(() => { setInterval(updateTime, 1000); updateTime(); fetchWeather(); setInterval(fetchWeather, 1800000); fetchRate(); setInterval(fetchRate, 1800000); });

            return { currentTab, japanTime, weather, weatherIcon, dates, selectedDate, filteredItinerary, switchDate, newItem, editingItineraryId, saveItinerary, startEditItinerary, cancelEditItinerary, removeItinerary, durationOptions, groupedPacking, newPack, addPackItem, togglePack, removePack, packProgress, currentRate, lastRateUpdate, calcJpy, calcTwd, calculateTwd, expense, expenseLogs, editingExpenseId, saveExpense, startEditExpense, cancelEditExpense, removeExpense };
        }
    }).mount('#app');
</script>
</body>
</html>